@using OSBIDE.Library.Models
@using OSBIDE.Web.Models.ViewModels
@using OSBIDE.Web.Models
@using OSBIDE.Library
@model OSBIDE.Web.Models.ViewModels.ProfileViewModel
@{
    ViewBag.Title = Model.User.FullName;
    OsbideUser currentUser = ViewBag.CurrentUser;
}

<section>
    <div class="feed-item-single-left">
        <img src="@Url.Action("Picture", "Profile", new { id = Model.User.Id })" title="profile image" alt="profile image" />
    </div>
    <div class="feed-item-single-right">
        <h1 style="display: inline;">@Model.User.FirstAndLastName</h1>
        @if (ViewBag.CurrentUser.Id == Model.User.Id)
        {
            <span>@Html.ActionLink("(Edit your profile)", "Edit")</span>
        }
        <h2>User Stats</h2>
    </div>
</section>
@if (Model.User.Id == currentUser.Id)
{
    int rowCounter = 0;
    <section id="subscriptions">
        <h1>My Subscriptions</h1>
        @if (Model.EventLogSubscriptions.Count() == 0)
        {
            @:You don't have any subscriptions.
        }
        else
        {
            <table id="subscriptions-table">
                <thead>
                    <tr>
                        <th>&nbsp;</th>
                        <th>Author</th>
                        <th>Event Type</th>
                        <th>Last Activity Date</th>
                        <th># Comments</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (AggregateFeedItem item in Model.EventLogSubscriptions)
                    {
                        rowCounter++;
                        string rowClass = "normal-row";
                        if (rowCounter % 2 == 0)
                        {
                            rowClass = "alt-row";
                        }
                        var lastComment = (from comment in item.Comments
                                           orderby comment.DatePosted descending
                                           select comment).FirstOrDefault();
                        string lastCommentText = "not available";
                        if (lastComment != null)
                        {
                            lastCommentText = lastComment.DatePosted.ToString("MM/dd @ hh:mmtt");
                        }
                    
                        <tr class="@rowClass">
                            <td>
                                <img src="@Url.Action("Picture", "Profile", new { id = item.Creator.Id, size = 24 })" height="24" width="24" title="profile image" alt="profile image" /></td>
                            <td>
                                @Html.ActionLink(item.Creator.FirstAndLastName, "Index", "Profile", new { id = item.Creator.Id, component = OsbideVsComponent.UserProfile }, new { })
                            </td>
                            <td>@item.PrettyName</td>
                            <td>@lastCommentText</td>
                            <td>@item.Comments.Count</td>
                            <td>
                                @Html.ActionLink("View", "Details", "Feed", new { id = item.Items.FirstOrDefault().LogId, component = OsbideVsComponent.FeedDetails }, new { })
                                <a style="padding-left:10px;" href="@Url.Action("UnfollowPost", "Feed", new { id = item.Items.FirstOrDefault().LogId, returnUrl = Request.Url.AbsoluteUri })">
                                    <img src="~/Content/icons/unfollow.png" title="unfollow" alt="unfollow" />
                                </a>

                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </section>
}
<section id="recent-comments">
    <h1>Recent Comments</h1>
    @foreach (LogComment comment in Model.RecentComments)
    {
        <section class="comment-single">
            @Html.ActionLink("On a post", "Details", "Feed", new { id = comment.Log.Id, component = OsbideVsComponent.FeedDetails }, new { })
            by
            @Html.ActionLink(comment.Log.Sender.FirstAndLastName, "Index", "Profile", new { id = comment.AuthorId, component = OsbideVsComponent.UserProfile }, new { }):
            <blockquote>@comment.Content</blockquote>
        </section>
    }
    @if (Model.RecentComments.Count() == 0)
    {
        @:No recent comments.
    }
</section>
<section>
    <h1>Recent Activity</h1>
    @Html.Partial("Feed/_Feed", Model.Feed)
</section>
